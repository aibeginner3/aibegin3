Option Explicit

Sub read()

    Dim myFilePath As String
    Dim outfilename As String
    Dim readfilename As String
    Dim FileName As String
    Dim Tmp As Variant
    Dim Tmp1, Tmp2 As String
    Dim nslide As Integer, row As Integer
    Const P2CM = 1 / 72 * 2.54  'Points To CentiMeters
    
    Dim SheetName As Object
    Set SheetName = Worksheets("Sheet1")

    For row = 1 To SheetName.Cells(1, 1).End(xlDown).row
        readfilename = SheetName.Cells(row, 1)
        nslide = SheetName.Cells(row, 2)
        If InStr(readfilename, "\") Then
            Tmp = Split(readfilename, "\")
            FileName = Tmp(UBound(Tmp))
            Tmp = Split(FileName, ".")
            FileName = Tmp(0)
        Else
            Tmp = Split(readfilename, ".")
            FileName = Tmp(0)
        End If
        
        outfilename = FileName & "_slide" & nslide & ".txt"
        myFilePath = ThisWorkbook.Path & "\txt\" & outfilename
        
        Open myFilePath For Output As #1
        
        Dim ppApp As New PowerPoint.Application
        ppApp.Visible = True
         
        Dim ppPrs As PowerPoint.Presentation
        Set ppPrs = ppApp.Presentations.Open(ThisWorkbook.Path & "\" & readfilename)
         
        Dim ppSld As PowerPoint.Slide
        Set ppSld = ppPrs.Slides(nslide)
        
        Dim ppShps As Object
        Set ppShps = ppSld.Shapes
        
        Dim ShpCnt As Long
        Dim ppShp As Object
        For ShpCnt = 1 To ppShps.Count
            Set ppShp = ppSld.Shapes(ShpCnt)
            With ppShp
                If .HasTextFrame Then
                    Print #1, Replace(.TextFrame.TextRange.Text, vbCr, vbCrLf)
                End If
            End With

        Next ShpCnt

        ppApp.Quit
        Set ppApp = Nothing
        Set ppPrs = Nothing
        Set ppSld = Nothing
        Set ppShps = Nothing
        Set ppShp = Nothing
        
        Close #1
        'Application.Wait Now() + TimeValue("00:00:01")
    
    Next row
    
    MsgBox "書出し完了"

End Sub
Sub classification_multi_slides()

    Dim myFilePath As String
    Dim outfilename As String
    Dim readfilename As String
    Dim AllCheckOutFile As String
    Dim FileName As String
    Dim Tmp As Variant
    Dim Tmp1, Tmp2 As String
    Dim nslide As Integer
    Dim nslideMax As Integer
    Dim row As Integer
    Dim rowEnd As Integer
    Dim clm As Column
    Dim cl As Cell
    Dim art As SmartArtNode
    Dim grp As GroupShapes
    Dim gsh As Object
    
    Const P2CM = 1 / 72 * 2.54  'Points To CentiMeters
    
    Dim SheetName As Object
    Set SheetName = Worksheets("Sheet1")

    rowEnd = SheetName.Cells(1, 1).End(xlDown).row
    Range(Cells(2, 3), Cells(rowEnd, 8)).Clear

    AllCheckOutFile = ThisWorkbook.Path & "\result_ppt_check.csv"
    
    Open AllCheckOutFile For Output As #1

    For row = 2 To rowEnd
        readfilename = SheetName.Cells(row, 1)
        If InStr(readfilename, "\") Then
            Tmp = Split(readfilename, "\")
            FileName = Tmp(UBound(Tmp))
            Tmp = Split(FileName, ".")
            FileName = Tmp(0)
        Else
            Tmp = Split(readfilename, ".")
            FileName = Tmp(0)
        End If
        
        Dim ppApp As New PowerPoint.Application
        ppApp.Visible = True
         
        Dim ppPrs As PowerPoint.Presentation
        Set ppPrs = ppApp.Presentations.Open(ThisWorkbook.Path & "\" & readfilename)
             
        nslideMax = 5
        If nslideMax > ppPrs.Slides.Count Then nslideMax = ppPrs.Slides.Count
        
        'nslide = SheetName.Cells(row, 2)
        For nslide = 1 To nslideMax
        
            outfilename = FileName & "_slide" & nslide & ".txt"
            myFilePath = ThisWorkbook.Path & "\txt\" & outfilename
            Open myFilePath For Output As #2
            
            Dim ppSld As PowerPoint.Slide
            Set ppSld = ppPrs.Slides(nslide)
            
            Dim ppShps As Object
            Set ppShps = ppSld.Shapes
            
            Dim ShpCnt As Long
            Dim ppShp As Object
            For ShpCnt = 1 To ppShps.Count
                Set ppShp = ppSld.Shapes(ShpCnt)
                With ppShp
                    'Debug.Print .Name
                    Print #1, _
                      readfilename & "," & nslide & "," & .Name & "," & _
                      Round(.Top * P2CM, 3) & "," & _
                      Round(.Left * P2CM, 3) & "," & _
                      Round(.Height * P2CM, 3) & "," & _
                      Round(.Width * P2CM, 3) & ","
    
                    'テキストボックス、プレースホルダ、オートシェイプの場合
                    If .HasTextFrame Then
                        'Debug.Print .TextFrame.TextRange.Text
                        Print #2, Replace(.TextFrame.TextRange.Text, vbCr, vbCrLf)
                        SheetName.Cells(row, 3) = "○"
        
                    '画像の場合
                    ElseIf InStr(.Name, "Picture") Or InStr(.Name, "図") Then
                        SheetName.Cells(row, 4) = "○"
                    
                    '表の場合
                    ElseIf .HasTable Then
                        For Each clm In .Table.Columns
                            For Each cl In clm.Cells
                                'Debug.Print cl.Shape.TextFrame.TextRange.Text
                                SheetName.Cells(row, 5) = "○"
                            Next
                        Next
        
                    'グラフの場合
                    ElseIf .HasChart Then
                        If .Chart.HasTitle Then
                            'Debug.Print .Chart.Title
                            SheetName.Cells(row, 6) = "○"
                        End If
        
                    'スマートアートの場合
                    ElseIf .HasSmartArt Then
                        For Each art In .SmartArt.Nodes
                            'Debug.Print art.TextFrame2.TextRange.Text
                            SheetName.Cells(row, 7) = "○"
                        Next
        
                    'グループの場合
                    ElseIf .Type = msoGroup Then
                        For Each gsh In .GroupItems
                            With gsh
                                Print #1, _
                                  readfilename & "," & nslide & "," & _
                                  ppShp.Name & "___" & .Name & "," & _
                                  Round(.Top * P2CM, 3) & "," & _
                                  Round(.Left * P2CM, 3) & "," & _
                                  Round(.Height * P2CM, 3) & "," & _
                                  Round(.Width * P2CM, 3) & ","
                                If .HasTextFrame Then
                                    'Debug.Print .TextFrame.TextRange.Text
                                    Print #2, Replace(.TextFrame.TextRange.Text, vbCr, vbCrLf)
                                    SheetName.Cells(row, 8) = "○"
                                End If
                            End With
                        Next
                    
                    End If
                    
                End With
    
            Next ShpCnt
            
            Set ppSld = Nothing
            Set ppShps = Nothing
            Set ppShp = Nothing
            Close #2
        Next nslide
    
        ppApp.Quit
        Set ppApp = Nothing
        Set ppPrs = Nothing
            
        'Application.Wait Now() + TimeValue("00:00:01")
        
    Next row
    
    Close #1
    
    MsgBox "書出し完了"

End Sub
Sub read_all()

    Dim myFilePath As String
    Dim outfilename As String
    Dim readfilename As String
    Dim nslide As Integer, row As Integer
    Const P2CM = 1 / 72 * 2.54  'Points To CentiMeters
    
    Dim SheetName As Object
    Set SheetName = Worksheets("Sheet1")
    outfilename = SheetName.Cells(1, 1).Text
    
    'テキストの出力先ファイル（デスクトップにテキストファイル）
    myFilePath = CreateObject("WScript.Shell").SpecialFolders("Desktop") & _
                 "\" & outfilename
    
    Open myFilePath For Output As #1

    For row = 1 To SheetName.Cells(1, 2).End(xlDown).row
        readfilename = SheetName.Cells(row, 2)
        nslide = SheetName.Cells(row, 3)
        
        Dim ppApp As New PowerPoint.Application
        ppApp.Visible = True
         
        Dim ppPrs As PowerPoint.Presentation
        Set ppPrs = ppApp.Presentations.Open(ThisWorkbook.Path & "\" & readfilename)
         
        Dim ppSld As PowerPoint.Slide
        Set ppSld = ppPrs.Slides(nslide)
        
        Dim ppShps As Object
        Set ppShps = ppSld.Shapes
        
        Dim ShpCnt As Long
        Dim ppShp As Object
        For ShpCnt = 1 To ppShps.Count
            Set ppShp = ppSld.Shapes(ShpCnt)
            With ppShp
                If .HasTextFrame Then
                    Print #1, _
                      readfilename & "," & nslide & "," & .Name & "," & _
                      Round(.Top * P2CM, 3) & "," & _
                      Round(.Left * P2CM, 3) & "," & _
                      Round(.Height * P2CM, 3) & "," & _
                      Round(.Width * P2CM, 3) & "," & .TextFrame.TextRange.Text
                Else
                    Print #1, _
                      readfilename & "," & nslide & "," & .Name & "," & _
                      Round(.Top * P2CM, 3) & "," & _
                      Round(.Left * P2CM, 3) & "," & _
                      Round(.Height * P2CM, 3) & "," & _
                      Round(.Width * P2CM, 3) & ","
                End If
            End With

        Next ShpCnt
    
        ppApp.Quit
        Set ppApp = Nothing
        Set ppPrs = Nothing
        Set ppSld = Nothing
        Set ppShps = Nothing
        Set ppShp = Nothing
        
    Next row
    
    Close #1
    MsgBox "書出し完了"

End Sub
Sub classification()

    Dim myFilePath As String
    Dim outfilename As String
    Dim readfilename As String
    Dim AllCheckOutFile As String
    Dim FileName As String
    Dim Tmp As Variant
    Dim Tmp1, Tmp2 As String
    Dim nslide As Integer
    Dim nslideMax As Integer
    Dim row As Integer
    Dim rowEnd As Integer
    Dim clm As Column
    Dim cl As Cell
    Dim art As SmartArtNode
    Dim grp As GroupShapes
    Dim gsh As Object
    
    Const P2CM = 1 / 72 * 2.54  'Points To CentiMeters
    
    Dim SheetName As Object
    Set SheetName = Worksheets("Sheet1")

    rowEnd = SheetName.Cells(1, 1).End(xlDown).row
    Range(Cells(2, 3), Cells(rowEnd, 8)).Clear

    AllCheckOutFile = ThisWorkbook.Path & "\result_ppt_check.csv"
    
    Open AllCheckOutFile For Output As #1

    For row = 2 To rowEnd
        readfilename = SheetName.Cells(row, 1)
        If InStr(readfilename, "\") Then
            Tmp = Split(readfilename, "\")
            FileName = Tmp(UBound(Tmp))
            Tmp = Split(FileName, ".")
            FileName = Tmp(0)
        Else
            Tmp = Split(readfilename, ".")
            FileName = Tmp(0)
        End If
        
        nslide = SheetName.Cells(row, 2)
        
        outfilename = FileName & "_slide" & nslide & ".txt"
        myFilePath = ThisWorkbook.Path & "\txt\" & outfilename
        Open myFilePath For Output As #2
        
        Dim ppApp As New PowerPoint.Application
        ppApp.Visible = True
         
        Dim ppPrs As PowerPoint.Presentation
        Set ppPrs = ppApp.Presentations.Open(ThisWorkbook.Path & "\" & readfilename)
             
        Dim ppSld As PowerPoint.Slide
        Set ppSld = ppPrs.Slides(nslide)
        
        Dim ppShps As Object
        Set ppShps = ppSld.Shapes
        
        Dim ShpCnt As Long
        Dim ppShp As Object
        For ShpCnt = 1 To ppShps.Count
            Set ppShp = ppSld.Shapes(ShpCnt)
            With ppShp
                'Debug.Print .Name
                Print #1, _
                  readfilename & "," & nslide & "," & .Name & "," & _
                  Round(.Top * P2CM, 3) & "," & _
                  Round(.Left * P2CM, 3) & "," & _
                  Round(.Height * P2CM, 3) & "," & _
                  Round(.Width * P2CM, 3) & ","

                'テキストボックス、プレースホルダ、オートシェイプの場合
                If .HasTextFrame Then
                    'Debug.Print .TextFrame.TextRange.Text
                    Print #2, Replace(.TextFrame.TextRange.Text, vbCr, vbCrLf)
                    SheetName.Cells(row, 3) = "○"
    
                '画像の場合
                ElseIf InStr(.Name, "Picture") Or InStr(.Name, "図") Then
                    SheetName.Cells(row, 4) = "○"
                
                '表の場合
                ElseIf .HasTable Then
                    For Each clm In .Table.Columns
                        For Each cl In clm.Cells
                            'Debug.Print cl.Shape.TextFrame.TextRange.Text
                            SheetName.Cells(row, 5) = "○"
                        Next
                    Next
    
                'グラフの場合
                ElseIf .HasChart Then
                    If .Chart.HasTitle Then
                        'Debug.Print .Chart.Title
                        SheetName.Cells(row, 6) = "○"
                    End If
    
                'スマートアートの場合
                ElseIf .HasSmartArt Then
                    For Each art In .SmartArt.Nodes
                        'Debug.Print art.TextFrame2.TextRange.Text
                        SheetName.Cells(row, 7) = "○"
                    Next
    
                'グループの場合
                ElseIf .Type = msoGroup Then
                    For Each gsh In .GroupItems
                        With gsh
                            Print #1, _
                              readfilename & "," & nslide & "," & _
                              ppShp.Name & "___" & .Name & "," & _
                              Round(.Top * P2CM, 3) & "," & _
                              Round(.Left * P2CM, 3) & "," & _
                              Round(.Height * P2CM, 3) & "," & _
                              Round(.Width * P2CM, 3) & ","
                            If .HasTextFrame Then
                                'Debug.Print .TextFrame.TextRange.Text
                                Print #2, Replace(.TextFrame.TextRange.Text, vbCr, vbCrLf)
                                SheetName.Cells(row, 8) = "○"
                            End If
                        End With
                    Next
                
                End If
                
            End With

        Next ShpCnt
    
        ppApp.Quit
        Set ppSld = Nothing
        Set ppShps = Nothing
        Set ppShp = Nothing
        Set ppApp = Nothing
        Set ppPrs = Nothing
            
        Close #2
        'Application.Wait Now() + TimeValue("00:00:01")
        
    Next row
    
    Close #1
    
    MsgBox "書出し完了"

End Sub
Sub OutputText()

　　Dim ppApp　 As Object ' // PowerPoint.Application
　　Dim ppPre　 As Object ' // PowerPoint.Presentation
　　Dim ppShp　 As Object ' // PowerPoint.Shape
　　Dim ppSld　 As Object ' // PowerPoint.Slide
　　Dim sPath　 As String
　　Dim sFnam　 As String
　　Dim i　　　 As Long
　　Dim sh　　　As Worksheet
　　
　　' // 処理対象のフォルダパス
　　sPath = "C:\"
　　
　　' // 初回ファイル検索
　　sFnam = Dir$(sPath & "\" & "*.ppt")
　　If Len(sFnam) = 0 Then
　　　　MsgBox "*.ppt が見つかりません", vbInformation
　　　　Exit Sub
　　End If
　　
　　On Error GoTo Err_
　　
　　' // PowerPoint起動
　　Set ppApp = CreateObject("PowerPoint.Application")
　　ppApp.Visible = True
　　' // 出力シート作成
　　Set sh = Workbooks.Add.Sheets(1)
　　With sh.Range("A1:D1")
　　　　.Font.Bold = True
　　　　.Value = Array("Filename", "Slide Number", "Shape Name", "Text")
　　End With
　　
　　' // リスト開始行番号
　　i = 2
　　' // *.ppt が見つからなくなるまでループ
　　Application.ScreenUpdating = False
　　While Len(sFnam) > 0
　　　　' // Presentation を開き、全ての Slide -その中の全ての Shape について
　　　　' // テキストがあればセルに出力する
　　　　Set ppPre = ppApp.Presentations.Open(Filename:=sPath & "\" & sFnam, _
　　　　　　　　　　　　　　　　　　　　　　 ReadOnly:=True)
　　　　For Each ppSld In ppPre.Slides
　　　　　　For Each ppShp In ppSld.Shapes
　　　　　　　　If ppShp.HasTextFrame Then
　　　　　　　　　　sh.Cells(i, "A").Value = sFnam
　　　　　　　　　　sh.Cells(i, "B").Value = ppSld.SlideNumber
　　　　　　　　　　sh.Cells(i, "C").Value = ppShp.Name
　　　　　　　　　　sh.Cells(i, "D").Value = Replace$(ppShp.TextFrame.TextRange.Text, _
　　　　　　　　　　　　　　　　　　　　　　　　　　　vbCr, vbLf)
　　　　　　　　　　i = i + 1
　　　　　　　　End If
　　　　　　Next
　　　　Next
　　　　' // Presentation を閉じ、次のファイルを検索
　　　　ppPre.Close
　　　　Set ppPre = Nothing
　　　　sFnam = Dir$()
　　Wend
　　ppApp.Quit
　　sh.Columns.AutoFit
　　sh.Rows.AutoFit

Bye_:
　　Set ppApp = Nothing
　　Set sh = Nothing
　　Exit Sub
Err_:
　　MsgBox Err.Description, vbCritical
　　Resume Bye_
End Sub



Sub プレゼンテーションファイルの全文字列をExcelに出力する()

　Dim xls As Object
　Dim i As Long
　Dim txt As String
　Dim sld As Slide
　Dim shp As Shape
　
　Set xls = CreateObject("Excel.Application")
　With xls
　
　　.Visible = True
　　.Workbooks.Add
　　.Range("A1").Value = "スライド番号"
　　.Range("B1").Value = "シェイプ名"
　　.Range("C1").Value = "文字列"
　　.Range("A1:C1").HorizontalAlignment = -4108 'xlCenter
　　
　　i = 2　　
　　For Each sld In ActivePresentation.Slides
　　　For Each shp In sld.Shapes
　　　　If shp.HasTextFrame Then
　　　　　.Cells(i, "A").Value = sld.SlideNumber
　　　　　.Cells(i, "B").Value = shp.Name
　　　　　'垂直タブ・キャリッジリターンをExcelの改行に置換
　　　　　txt = shp.TextFrame.TextRange.Text
　　　　　txt = Replace(txt, Chr(11), vbLf)
　　　　　txt = Replace(txt, vbCr, vbLf)
　　　　　.Cells(i, "C").Value = txt
　　　　　i = i + 1
　　　　End If
　　　Next shp
　　Next sld
　　
　　.Columns("A:B").EntireColumn.AutoFit
　　.Columns("C:C").ColumnWidth = 100
　　.Range("A1", .Cells(i, "C")).VerticalAlignment = -4160 'xlTop
　　.Range("A1", .Cells(i, "C")).WrapText = True
　　
　End With
　Set xls = Nothing

End Sub




Public Sub FindText3()
    Dim sld As Slide
    Dim sh As Shape
    Dim clm As Column
    Dim cl As Cell
    Dim art As SmartArtNode
    Dim grp As GroupShapes

    For Each sld In ActivePresentation.Slides
        For Each sh In sld.Shapes

            'テキストボックス、プレースホルダ、オートシェイプの場合
            If sh.HasTextFrame Then
                Debug.Print sh.TextFrame.TextRange.text

            '表の場合
            ElseIf sh.HasTable Then
                For Each clm In sh.Table.Columns
                    For Each cl In clm.cells
                        Debug.Print cl.Shape.TextFrame.TextRange.text
                    Next
                Next

            'グラフの場合
            ElseIf sh.HasChart Then
                If sh.Chart.HasTitle Then Debug.Print sh.Chart.Title

            'スマートアートの場合
            ElseIf sh.HasSmartArt Then
                For Each art In sh.SmartArt.Nodes
                    Debug.Print art.TextFrame2.TextRange.text
                Next

            'グループの場合
            ElseIf sh.Type = msoGroup Then
                For Each gsh In sh.GroupItems
                    If gsh.HasTextFrame Then Debug.Print gsh.TextFrame.TextRange.text
                Next

            End If

        Next
    Next
End Sub



Public Sub Traverse()
    Dim sh As Shape
    Dim gsh As Shape
     
    'スライド中の全アイテムをループ
    For Each sh In ActivePresentation.Slides(1).Shapes
        Debug.Print sh.Type  '(A)
        Debug.Print "---"
         
        If sh.Type = msoGroup Then
            'グループ中のアイテムをループ
            For Each gsh In sh.GroupItems
                Debug.Print gsh.Type  '(B)
            Next
        End If
    Next
End Sub


Sub アクティブスライドのグループ化図形をすべてグループ解除する()
　Dim has_grp As Boolean　''グループ化された図形の存在を示すフラグ
　Dim shp As Shape

　has_grp = True
　Do While has_grp
　　For Each shp _
　　In ActiveWindow.Selection.SlideRange.Shapes
　　　If shp.Type = msoGroup Then
　　　　has_grp = True
　　　　shp.Ungroup
　　　　Exit For    ' PPT VBAの時のみ必要
　　　Else
　　　　has_grp = False
　　　End If　　　
　　Next shp
　Loop
End Sub
Option Explicit
 
Public Sub Sample()
  Dim sld As PowerPoint.Slide
  Dim shp As PowerPoint.Shape
  Dim gshps As PowerPoint.GroupShapes
  Dim tmpsld As PowerPoint.Slide
  Dim tmpvt As PowerPoint.PpViewType
   
  If Application.SlideShowWindows.Count > 0& Then Exit Sub
  tmpvt = Application.ActiveWindow.ViewType
  Application.ActiveWindow.ViewType = ppViewNormal
  Set tmpsld = Application.ActivePresentation.Slides.FindBySlideID _
  (Application.ActivePresentation.Windows(1).Selection.SlideRange.SlideID)
  For Each sld In Application.ActivePresentation.Slides
    For Each shp In sld.Shapes
      Set gshps = Nothing
      On Error Resume Next
      Set gshps = shp.GroupItems
      On Error GoTo 0
      If gshps Is Nothing Then
        SortShape shp
      Else
        SortGroupShape gshps
      End If
    Next
  Next
  tmpsld.Select
  Application.ActiveWindow.ViewType = tmpvt
End Sub
 
Private Sub SortGroupShape(ByVal gshps As PowerPoint.GroupShapes)
'グループ化されたシェイプの振り分け
  Dim shp As PowerPoint.Shape
  Dim subgshps As PowerPoint.GroupShapes
   
  For Each shp In gshps
    Set subgshps = Nothing
    On Error Resume Next
    Set subgshps = shp.GroupItems
    On Error GoTo 0
    If subgshps Is Nothing Then
      SortShape shp
    Else
      SortGroupShape subgshps
    End If
  Next
End Sub
 
Private Sub SortShape(ByVal shp As PowerPoint.Shape)
'シェイプの振り分け
  Dim n As Office.SmartArtNode
  Dim clm As PowerPoint.Column
  Dim c As PowerPoint.Cell
     
  Select Case shp.Type
    Case msoSmartArt
      For Each n In shp.SmartArt.Nodes
        If n.TextFrame2.HasText = True Then MainProcSmartArtNode n
      Next
    Case msoTable
      For Each clm In shp.Table.Columns
        For Each c In clm.Cells
          If c.Shape.TextFrame.HasText = True Then MainProcShape c.Shape
        Next
      Next
    Case msoChart
      MainProcChart shp
    Case Else
      If shp.TextFrame.HasText = True Then MainProcShape shp
  End Select
End Sub
 
Private Sub MainProcShape(ByRef shp As PowerPoint.Shape)
  Debug.Print shp.Parent.Name, shp.TextFrame.TextRange.Text
End Sub
 
Private Sub MainProcSmartArtNode(ByRef nd As Office.SmartArtNode)
  Debug.Print nd.Parent.Name, nd.TextFrame2.TextRange.Text
End Sub
 
Private Sub MainProcChart(ByRef shp As PowerPoint.Shape)
  Dim r As Object
   
  On Error Resume Next
  shp.Parent.Select: DoEvents: shp.Select
  Application.CommandBars.ExecuteMso "ChartShowData"
  If Err.Number = 0 Then
    For Each r In shp.Chart.ChartData.Workbook.ActiveSheet.UsedRange
      Debug.Print shp.Parent.Name, r.Text
    Next
    shp.Chart.ChartData.Workbook.Close
  Else
    Debug.Print shp.Name & "のセル内容の取得に失敗しました。"
  End If
  On Error GoTo 0
End Sub
Sub read()

    Dim myFilePath As String
    Dim outfilename As String
    Dim readfilename As String
    Dim nslide As Integer, row As Integer
    Const P2CM = 1 / 72 * 2.54  'Points To CentiMeters
    
    Dim SheetName As Object
    Set SheetName = Worksheets("Sheet1")
    outfilename = SheetName.Cells(1, 1).Text
    
    'テキストの出力先ファイル（デスクトップにテキストファイル）
    myFilePath = CreateObject("WScript.Shell").SpecialFolders("Desktop") & _
                 "\" & outfilename
    
    Open myFilePath For Output As #1

    For row = 1 To SheetName.Cells(1, 2).End(xlDown).row
        readfilename = SheetName.Cells(row, 2)
        nslide = SheetName.Cells(row, 3)
        
        Dim ppApp As New PowerPoint.Application
        ppApp.Visible = True
         
        Dim ppPrs As PowerPoint.Presentation
        Set ppPrs = ppApp.Presentations.Open(ThisWorkbook.Path & "\" & readfilename)
         
        Dim ppSld As PowerPoint.Slide
        Set ppSld = ppPrs.Slides(nslide)
        
        Dim ppShps As Object
        Set ppShps = ppSld.Shapes
        
        Dim ShpCnt As Long
        Dim ppShp As Object
        For ShpCnt = 1 To ppShps.Count
            Set ppShp = ppSld.Shapes(ShpCnt)
            With ppShp
                If .HasTextFrame Then
                    Print #1, _
                      readfilename & "," & nslide & "," & .Name & "," & _
                      Round(.Top * P2CM, 3) & "," & _
                      Round(.Left * P2CM, 3) & "," & _
                      Round(.Height * P2CM, 3) & "," & _
                      Round(.Width * P2CM, 3) & "," & .TextFrame.TextRange.Text
                Else
                    Print #1, _
                      readfilename & "," & nslide & "," & .Name & "," & _
                      Round(.Top * P2CM, 3) & "," & _
                      Round(.Left * P2CM, 3) & "," & _
                      Round(.Height * P2CM, 3) & "," & _
                      Round(.Width * P2CM, 3) & ","
                End If
            End With

        Next ShpCnt
    
        ppApp.Quit
        Set ppApp = Nothing
        Set ppPrs = Nothing
        Set ppSld = Nothing
        Set ppShps = Nothing
        Set ppShp = Nothing
        
    Next row
    
    Close #1
    MsgBox "書出し完了"

End Sub




